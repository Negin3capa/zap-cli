#!/bin/bash
set -e

echo "ğŸš€ ZapTUI - Starting..."
echo ""

# Change to script directory
cd "$(dirname "$0")"

# Check if Node.js is installed
if ! command -v node &> /dev/null; then
    echo "âŒ Error: Node.js is not installed"
    echo "Please install Node.js from: https://nodejs.org/"
    exit 1
fi

# Check if Rust binary exists
if [ ! -f "./target/release/zaptui" ]; then
    echo "ğŸ“¦ First time setup: Building Rust binary..."
    cargo build --release
fi

# Check if WhatsApp service dependencies are installed
if [ ! -d "./whatsapp-service/node_modules" ]; then
    echo "ğŸ“¦ First time setup: Installing WhatsApp service..."
    cd whatsapp-service
    npm install --silent
    cd ..
fi

echo "âœ… Setup complete"
echo ""

# Check if port 8080 is already in use
if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null 2>&1 ; then
    echo "âŒ Error: Port 8080 is already in use by another application"
    echo ""
    echo "To fix this, run:"
    echo "  sudo lsof -ti:8080 | xargs kill -9"
    echo ""
    echo "Or change the port in:"
    echo "  - whatsapp-service/server.js (line 83: port: 8080)"
    echo "  - config.toml (service_url)"
    exit 1
fi

# Function to cleanup on exit
cleanup() {
    echo ""
    echo "ğŸ›‘ Stopping WhatsApp service..."
    
    # Kill the PID we started (if we have it)
    if [ ! -z "$WA_PID" ]; then
        kill $WA_PID 2>/dev/null || true
    fi
    
    # Also kill ANY node process running server.js (in case of previous failures)
    pkill -f "node.*server.js" 2>/dev/null || true
    
    # Double-check port 8080 is freed
    sleep 1
    if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null 2>&1; then
        echo "âš ï¸  Force-killing process on port 8080..."
        lsof -ti:8080 | xargs kill -9 2>/dev/null || true
    fi
    
    echo "âœ… Cleanup complete"
    exit 0
}

trap cleanup SIGINT SIGTERM EXIT

# Start WhatsApp service in background
echo "ğŸ”Œ Starting WhatsApp service..."
cd whatsapp-service
node server.js > /dev/null 2>&1 &
WA_PID=$!
cd ..

# Wait a bit for service to start
sleep 2

# Check if service started successfully
if ! kill -0 $WA_PID 2>/dev/null; then
    echo "âŒ Failed to start WhatsApp service"
    exit 1
fi

echo "âœ… WhatsApp service running (port 8080)"
echo ""
echo "ğŸ¨ Starting TUI..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Run the TUI
./target/release/zaptui

# Cleanup happens automatically via trap
